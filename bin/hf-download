#!/bin/bash
#
# hf-download - Download models from Hugging Face
#
# Downloads models to ~/models maintaining the same directory structure
# as the repository (organization/model-name), compatible with lm-studio.
#
# Usage:
#   hf-download <repo>              # Download entire repo
#   hf-download <repo> <file>       # Download specific file (e.g., *.gguf)
#   hf-download <repo> --pattern <glob>  # Download files matching pattern
#
# Examples:
#   hf-download TheBloke/Llama-2-7B-GGUF llama-2-7b.Q4_K_M.gguf
#   hf-download mlx-community/Llama-3.2-3B-Instruct-4bit
#   hf-download TheBloke/Mistral-7B-GGUF --pattern "*Q4_K_M*"
#

set -e

MODELS_DIR="${HF_MODELS_DIR:-$HOME/models}"

usage() {
    echo "Usage: hf-download <repo> [file] [--pattern <glob>]"
    echo ""
    echo "Download Hugging Face models to ~/models"
    echo ""
    echo "Arguments:"
    echo "  repo      Repository in format 'org/model-name'"
    echo "  file      Optional: specific file to download"
    echo ""
    echo "Options:"
    echo "  --pattern <glob>  Download files matching glob pattern"
    echo "  -h, --help        Show this help message"
    echo ""
    echo "Environment:"
    echo "  HF_MODELS_DIR     Override default models directory (default: ~/models)"
    echo ""
    echo "Examples:"
    echo "  hf-download TheBloke/Llama-2-7B-GGUF llama-2-7b.Q4_K_M.gguf"
    echo "  hf-download mlx-community/Llama-3.2-3B-Instruct-4bit"
    echo "  hf-download TheBloke/Mistral-7B-GGUF --pattern '*Q4_K_M*'"
    exit "${1:-0}"
}

# Check for hf
if ! command -v hf >/dev/null 2>&1; then
    echo "Error: hf not found"
    echo ""
    echo "Install with: pip install huggingface_hub"
    echo "Or: brew install hf"
    exit 1
fi

# Parse arguments
REPO=""
FILE=""
PATTERN=""

while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            usage
            ;;
        --pattern)
            PATTERN="$2"
            shift 2
            ;;
        *)
            if [[ -z "$REPO" ]]; then
                REPO="$1"
            elif [[ -z "$FILE" ]]; then
                FILE="$1"
            else
                echo "Error: unexpected argument '$1'"
                usage 1
            fi
            shift
            ;;
    esac
done

# Validate repo argument
if [[ -z "$REPO" ]]; then
    echo "Error: repository required"
    echo ""
    usage 1
fi

# Validate repo format (should contain a slash)
if [[ ! "$REPO" =~ ^[^/]+/[^/]+$ ]]; then
    echo "Error: invalid repository format"
    echo "Expected format: organization/model-name"
    echo "Example: TheBloke/Llama-2-7B-GGUF"
    exit 1
fi

# Set up destination directory
DEST_DIR="$MODELS_DIR/$REPO"

echo "Downloading from Hugging Face"
echo "============================="
echo "Repository: $REPO"
echo "Destination: $DEST_DIR"
[[ -n "$FILE" ]] && echo "File: $FILE"
[[ -n "$PATTERN" ]] && echo "Pattern: $PATTERN"
echo ""

# Create destination directory
mkdir -p "$DEST_DIR"

# Build the download command
CMD=(hf download "$REPO")

# Add file or pattern if specified
if [[ -n "$FILE" ]]; then
    CMD+=("$FILE")
elif [[ -n "$PATTERN" ]]; then
    CMD+=(--include "$PATTERN")
fi

# Add destination directory
CMD+=(--local-dir "$DEST_DIR")

# Execute download
echo "Running: ${CMD[*]}"
echo ""

if "${CMD[@]}"; then
    echo ""
    echo "Download complete!"
    echo "Model saved to: $DEST_DIR"

    # Show downloaded files
    echo ""
    echo "Contents:"
    ls -lh "$DEST_DIR" | head -20
else
    echo ""
    echo "Download failed"
    exit 1
fi
